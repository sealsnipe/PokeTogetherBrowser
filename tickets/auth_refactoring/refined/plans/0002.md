# Implementierungsplan für Ticket 0002: Player Model anpassen

**Ziel:** Das Sequelize-Modell `Player` (`server/models/Player.js`) erweitern, um E-Mail, Rolle, Aktivitätsstatus und sicheres Passwort-Hashing zu unterstützen, basierend auf der detaillierten Beschreibung in `tickets/auth_refactoring/refined/ticket_0002_Player_Model_Anpassen.md`.

**Schritte:**

1.  **Datei öffnen:** `server/models/Player.js`
2.  **Imports & Konstanten hinzufügen:**
    *   Importiere `bcrypt`: `const bcrypt = require('bcrypt');`
    *   Definiere die Konstante für den Hashing-Aufwand: `const SALT_ROUNDS = 10;`
3.  **Felddefinitionen anpassen (innerhalb von `sequelize.define('Player', { ... })`):**
    *   **`username`:** Füge Validierungen hinzu (`notEmpty`, `len`).
    *   **`email`:** Füge das Feld hinzu (Typ: `STRING(100)`, `allowNull: true`, `unique`, `validate: { isEmail }`).
    *   **`password_hash`:** Stelle sicher, dass `allowNull: false` gesetzt ist.
    *   **`role`:** Füge das Feld hinzu (Typ: `STRING(20)`, `defaultValue: 'player'`, `allowNull: false`, `validate: { isIn }`).
    *   **`is_active`:** Füge das Feld hinzu (Typ: `BOOLEAN`, `defaultValue: true`, `allowNull: false`).
    *   **`last_login`:** Stelle sicher, dass das Feld vorhanden ist (Typ: `DATE`, `allowNull: true`).
    *   *(Optional/Gemäß Beispiel)* **`map_id`:** Füge das Feld hinzu (Typ: `STRING`, `allowNull: false`, `defaultValue: 'default_map'`).
    *   Behalte die bestehenden Felder `id`, `position_x`, `position_y`, `is_running`, `created_at` bei.
4.  **Modell-Optionen hinzufügen (zweites Argument von `sequelize.define`):**
    *   Füge das Options-Objekt `{ ... }` hinzu.
    *   Setze `timestamps: true`.
    *   Setze `underscored: true`.
    *   Füge das `hooks`-Objekt hinzu:
        *   Implementiere den `beforeCreate`-Hook (async, prüft `player.password_hash`, hasht mit `bcrypt.hash` und `SALT_ROUNDS`).
        *   Implementiere den `beforeUpdate`-Hook (async, prüft `player.changed('password_hash')`, prüft, ob es noch kein Hash ist, hasht mit `bcrypt.hash` und `SALT_ROUNDS`).
    *   Füge das `defaultScope`-Objekt hinzu (`attributes: { exclude: ['password_hash'] }`).
    *   Füge das `scopes`-Objekt hinzu mit dem `withPassword`-Scope (`attributes: { include: ['password_hash'] }`).
5.  **Instanzmethode hinzufügen (nach `sequelize.define`, vor `return Player;`):**
    *   Definiere `Player.prototype.checkPassword = async function(password) { ... }`.
    *   Implementiere die Logik mit `bcrypt.compare`, inklusive Prüfungen auf `!password` und `!this.password_hash` und `try...catch`.

**Visueller Überblick (Geplante Struktur):**

```mermaid
graph TD
    A[Start: Player.js anpassen] --> B(Imports & Konstanten);
    B --> C(Felder definieren/anpassen);
    C --> D(Modell-Optionen hinzufügen);
    D --> E(Hooks implementieren);
    E --> F(Scopes definieren);
    F --> G(checkPassword Methode hinzufügen);
    G --> H[Ende: Player.js angepasst];

    subgraph "Schritt 1-2"
        B
    end
    subgraph "Schritt 3"
        C
    end
    subgraph "Schritt 4"
        D
        E
        F
    end
     subgraph "Schritt 5"
        G
    end